# Introduction #

At the point of having implemented two card types (and received the Wookie contribution), I am aware that card functionality is not always easy to unit-test, and that I need to develop an interface that supports linkage between cards (for collections, etc.).

# MVC pattern #

I propose to address this by adopting a version of the Model-View-Controller (MVC) pattern for card plugins, following a design that was developed by Alistair Miles for the FlyWeb project.  Essentially, all external interactions take place via a control interface which updates the card state (Model), all updates to the card display (view) are enacted via subscription to associated model values, and all user interactions are effected via calls to the controller interface.  In this way, all interactions can be simulated through the controller interface, and the resulting changes observed in both the model and the DOM.

It all looks something like this:
```
Initialization     External events <--+
 | (call)           |                 |
 |                  |                 |
 |<-----------------+                 |
 |       (subscribe)                  |
 |                          (publish) |
 |            +-->--------------------+
 |            |
 +--> Controller <--------------------------------------+ 
       |                                    (subscribe) |
       | (call)                                         |
       +--> Model                                       |
             |                                          |
             | (subscribe)                              |
             +--> Renderer                              |
                   |                                    |
                   | (call)                             |
                   +--> DOM                             |
                         |                              |
                         +--> user input collector -->--+
```

## Model ##

Shuffl and card plug-ins use the jQuery(...).data() method to store card-related data, and this seems an appropriate basis for the card model. This can be implemented as a jQuery plugin that attaches appropriate functionality to any page element.  The interface would look like this:

  * jQuery(...).model("name", value) - set a value in the model, and trigger any listeners subscribed to that value.
  * jQuery(...).model("name") - retrieve a value from the model.
  * jQuery(...).modelBind("name", function) - subscribe a listener to changes in a model value.
  * jQuery(...).modelUnbind("name", function) - unsubscribe a listener to changes in a model value.

The listener function is called thus, with `this` referencing the DOM element of the jQuery object whose model is changed:
```
    listener(event, {name: "name", old: oldvalue, new: newvalue});
```

## View ##

The card view is represented by its current DOM. View rendering is performed by listeners that are subscribed to model value changes.

User input elements are linked to controller methods, so that any user action can be mimicked programmatically by a call to a controller method.  This is particularly useful for unit testing.

## Controller ##

The external interface presented by a card, including the following methods:
  * set model value
  * get model value
  * serialize for output (returns object ready for serialization to any supported format - currently JSON)
  * subscribe a listener to a controller event, via jQuery(this).bind(...).
  * listen to event generated by another card or component, via jQuery(...).bind(...).
  * publish an event for external listeners, via jQuery(this).trigger(...).

Additional methods associated with a card plugin (type) are:
  * register card factory - this is the point at which a card plugin becomes part of a Shuffl application.
  * create new card - accessed via card factory lookup.

# Migration plan #

  * define namespace for Shuffl card types (shuffl.card...)
  * implement existing card types as members of the new namespace
  * when creating a new card, define all other functions as methods on the card object (currently, this is the json export).
  * implement .model() functionality (as jQuery plugin?).  With test cases.
  * replace all references to card.data(...) with card.model(...). Add test cases for model updates.
  * implement all user input event handling via calls on controller methods on the card. Add test cases.
  * implement all card DOM manipulation via model-change listeners. Add test cases.